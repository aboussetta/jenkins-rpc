---
- name: Authorize SSH keys
  tags: keys
  authorized_key: key="{{lookup('file', item|basename)}}" user=root state=present
  with_fileglob: id_*.pub

- name: Updating packages
  tags: packages
  apt: update_cache=yes upgrade=dist

- name: Install packages
  tags: packages
  apt: pkg=bridge-utils state=present

- name: Configure management interface
  interfaces: >
    name={{iface.name}}
    iface_type=static
    address={{iface.tunnel}}

- name: Configure vxlan42 tunnel
  interfaces: >-
    name=vxlan42
    iface_type=manual
    updown="pre-up ip link add vxlan42 type vxlan id 42 group 239.0.0.42 dev {{iface.name}} || true","up ip link set $IFACE up","down ip link set $IFACE down","post-down ip link del vxlan42 || true"

- name: Configure br-mgmt bridge
  interfaces: >-
    name=br-mgmt
    iface_type=static
    address={{iface.ipv4}}
    updown="bridge_ports vxlan42"

# - name: Configure /etc/network/interfaces to source fragments
#   tags: networks
#   lineinfile: dest=/etc/network/interfaces regexp="^source" line="source /etc/network/interfaces.d/*.cfg"
